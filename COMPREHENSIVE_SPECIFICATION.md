# 料理管理システム 総合仕様書

## 📋 システム概要

家族の人数と好みに合わせて1週間分の夕飯メニューを提案し、買い物リストと在庫管理ができる総合的な料理管理システムです。AIチャットボット連携により、より高度で個性的なメニュー生成が可能です。

### 🎯 主要目標
- 家族に適したメニューの自動生成
- 在庫を活用した食材ロス削減
- 効率的な買い物計画の作成
- 料理評価による継続的な改善

## 🏗️ システム構成

### フロントエンド技術スタック
- **React 18**: UIライブラリ
- **TypeScript**: 型安全性の確保
- **Tailwind CSS**: レスポンシブデザイン
- **Lucide React**: 統一されたアイコンセット
- **Vite**: 高速ビルドツール

### バックエンド技術スタック
- **Supabase**: データベース・認証基盤
- **PostgreSQL**: リレーショナルデータベース
- **Row Level Security**: データセキュリティ
- **Dify API**: AIチャットボット連携

## 🔐 認証システム

### 認証方式
- **メール・パスワード認証**: Supabase Auth使用
- **セッション管理**: 自動ログイン状態維持
- **セキュリティ**: Row Level Security（RLS）によるデータ保護

### 認証フロー
1. アカウント作成（メール確認なし）
2. ログイン・ログアウト
3. 認証状態の自動監視
4. 未認証時の適切なリダイレクト

## 📱 ページ構成・機能詳細

### 1. ホーム画面（HomePage）

#### 基本機能
- **現在の設定表示**: 家族人数、ヘルスモード、好み
- **期間設定**: 開始日・終了日の選択
- **料理種類配分**: 和食・洋食・中華の日数指定
- **調理時間制約**: 忙しい日の時間制限設定

#### AIチャットボット連携
- **Dify設定**: APIエンドポイント・キー管理
- **AI生成切替**: ローカル生成 vs AI生成
- **接続状態表示**: 設定済み・未設定の視覚的表示

#### メニュー生成条件
```typescript
interface MenuGenerationOptions {
  busyDates: string[];           // 忙しい日付配列
  maxCookingTime: number;        // 最大調理時間（分）
  cuisineDistribution: {         // 料理ジャンル配分
    japanese: number;
    western: number;
    chinese: number;
  };
  useDifyBot: boolean;          // AI使用フラグ
  difyConfig?: {                // Dify設定
    apiEndpoint: string;
    apiKey: string;
  };
}
```

### 2. 基本設定画面（SettingsPage）

#### 家族構成設定
- **詳細情報入力**:
  - 名前（任意）
  - 生年月日（年・月・日選択）
  - 性別（男性・女性）
  - 食べる量（1-5段階スライダー）
- **年齢自動計算**: 生年月日から現在年齢を表示
- **家族人数同期**: 家族構成の人数で自動更新

#### ヘルスモード設定
- **通常モード**: バランスの良い食事
- **ダイエットモード**: 低カロリー・ヘルシー志向
- **筋トレモード**: 高タンパク・筋肉増強

#### 料理評価別出現頻度
- **S級料理**: 設定日数に1回（デフォルト: 2日に1回）
- **A級料理**: 設定日数に1回（デフォルト: 3日に1回）
- **B級料理**: 設定日数に1回（デフォルト: 7日に1回）
- **C級料理**: 献立から自動除外

#### 好み設定
- **自由記述**: 辛い料理、野菜多め、アレルギー情報など
- **AI連携**: 自然言語での好み解析

### 3. メニュー管理画面（MenuPage）

#### メニュー表示
- **日付別カード表示**: 曜日・日付ごとの献立
- **献立構成**:
  - 主菜（必須・100%）
  - 副菜（確率的・80%）
  - 汁物（確率的・60%）
- **調理情報**: 合計時間、難易度、必要食材

#### インタラクティブ機能
- **ドラッグ&ドロップ**: 日付間の献立入れ替え
- **個別メニュー変更**: 特定日のメニュー再生成
- **お気に入り登録**: ハートボタンでワンクリック保存
- **詳細表示**: 展開・折りたたみ機能

#### 操作フロー
```
1. メニュー生成 → 2. 内容確認 → 3. 調整・入れ替え → 4. 買い物リスト作成
```

### 4. 買い物管理

#### 買い物リスト画面（ShoppingListPage）
- **カテゴリ別表示**: 野菜・肉魚・調味料・その他
- **必要量計算**: 在庫考慮の購入必要量
- **料理別内訳**: どの料理にどれだけ必要か
- **進捗管理**: チェック機能と完了率表示

#### モバイル買い物画面（MobileShoppingPage）
- **大型ボタンUI**: タッチ操作に最適化
- **カテゴリ色分け**: 視認性向上
- **一括確定**: 選択アイテムの一括購入完了
- **自動在庫更新**: 購入完了時の在庫反映

### 5. 在庫管理画面（InventoryPage）

#### 在庫表示・管理
- **期限管理**:
  - 期限切れ（赤色・警告表示）
  - 期限間近（黄色・3日以内）
  - 新鮮（緑色・安全）
- **自動ソート**: 期限順での優先表示
- **検索・フィルター**: 食材名検索、カテゴリ絞り込み

#### CRUD操作
- **追加**: フローティングボタンから新規追加
- **編集**: 既存アイテムの情報変更
- **削除**: 不要アイテムの削除
- **自動更新**: 買い物完了時の自動在庫追加

### 6. お気に入り・評価管理画面（FavoritesPage）

#### タブ構成
- **お気に入り**: 手動追加のお気に入りレシピ
- **S級**: 18-20点の最高評価料理
- **A級**: 14-17点の高評価料理
- **B級**: 7-13点の普通評価料理
- **C級**: 6点以下の低評価料理（献立除外対象）

#### 評価システム
- **4項目評価**（各1-5星）:
  - おいしかった
  - 調理時間の満足度
  - 難易度の満足度
  - またつくりたい
- **総合評価**: 4項目合計でS/A/B/C自動判定
- **評価日表示**: 評価実施日の記録

### 7. カレンダー機能（CalendarPage）

#### カレンダー表示
- **月表示**: 標準カレンダーレイアウト
- **メニュー表示**: 各日の献立概要
- **完了状態**: 調理完了日のマーク表示
- **統計情報**: 総メニュー数、月間メニュー数など

#### 調理完了機能
- **完了マーク**: その日の料理完了登録
- **評価入力**: 完了時の料理評価（4項目）
- **在庫消費**: 使用食材の自動在庫減算
- **完了リセット**: 誤操作時のリセット機能

## 🗄️ データベース設計

### テーブル構成

#### user_profiles（ユーザー設定）
```sql
- id (uuid, PK): ユーザーID
- family_count (integer): 家族人数
- preferences (text): 好み設定
- family_members (text): 家族構成詳細（JSON）
- health_mode (text): ヘルスモード
- recipe_frequency (jsonb): 評価別出現頻度
- created_at, updated_at (timestamptz): 作成・更新日時
```

#### user_inventory（在庫管理）
```sql
- id (uuid, PK): 在庫ID
- user_id (uuid, FK): ユーザーID
- name (text): 食材名
- amount (numeric): 数量
- unit (text): 単位
- category (text): カテゴリ
- expiration_date (date): 賞味期限
- created_at, updated_at (timestamptz): 作成・更新日時
```

#### user_menu_plans（メニュープラン）
```sql
- id (uuid, PK): プランID
- user_id (uuid, FK): ユーザーID
- recipes (jsonb): レシピ情報
- generated_date (timestamptz): 生成日時
- created_at (timestamptz): 作成日時
```

#### user_shopping_lists（買い物リスト）
```sql
- id (uuid, PK): リストID
- user_id (uuid, FK): ユーザーID
- items (jsonb): 買い物アイテム
- created_at, updated_at (timestamptz): 作成・更新日時
```

#### user_favorites（お気に入り）
```sql
- id (uuid, PK): お気に入りID
- user_id (uuid, FK): ユーザーID
- recipe_name (text): レシピ名
- cooking_time (integer): 調理時間
- difficulty (integer): 難易度
- ingredients (jsonb): 食材情報
- created_at (timestamptz): 作成日時
```

#### user_purchased_items（購入履歴）
```sql
- id (uuid, PK): 購入ID
- user_id (uuid, FK): ユーザーID
- ingredient_name (text): 食材名
- amount (numeric): 購入量
- unit (text): 単位
- category (text): カテゴリ
- purchased_date (date): 購入日
- created_at (timestamptz): 作成日時
```

#### user_completed_days（調理完了記録）
```sql
- id (uuid, PK): 完了ID
- user_id (uuid, FK): ユーザーID
- completed_date (date): 完了日
- recipes_used (jsonb): 使用レシピ
- created_at (timestamptz): 作成日時
```

#### user_recipe_ratings（料理評価）
```sql
- id (uuid, PK): 評価ID
- user_id (uuid, FK): ユーザーID
- recipe_name (text): レシピ名
- taste (integer): おいしさ（1-5）
- cooking_time (integer): 調理時間満足度（1-5）
- difficulty (integer): 難易度満足度（1-5）
- would_make_again (integer): またつくりたい（1-5）
- rated_date (date): 評価日
- created_at (timestamptz): 作成日時
```

### セキュリティ設計
- **Row Level Security**: 全テーブルでRLS有効
- **認証ポリシー**: ユーザー固有データの完全分離
- **外部キー制約**: データ整合性の保証

## 🤖 AIチャットボット連携

### Dify連携仕様

#### 入力データ構造（システム → Dify）
```typescript
interface DifyChatbotRequest {
  week_start_date: string;        // 開始日（YYYY-MM-DD）
  days: number;                   // 日数
  people: number;                 // 人数
  diet_mode: boolean;             // ダイエットモード
  budget_per_day_jpy: number;     // 1日予算
  time_limit_per_day_min: number; // 調理時間制限
  preferred_genres: string[];     // 好みジャンル
  avoid_genres: string[];         // 避けるジャンル
  allergies: string[];            // アレルギー情報
  dislikes: string[];             // 嫌いな食材
  must_use_ingredients: string[]; // 必須使用食材
  inventory: {                    // 在庫情報
    invId: string;
    name: string;
    qty: number;
    unit: string;
    category: string;
    expires_at: string;
    priority_hint: 'overstock' | 'near_expiry' | 'normal';
  }[];
  pantry: {                       // 常備調味料
    name: string;
    unit: string;
  }[];
  busy_dates?: string[];          // 忙しい日付
  max_cooking_time?: number;      // 最大調理時間
  cuisine_distribution?: {        // 料理配分
    japanese: number;
    western: number;
    chinese: number;
  };
}
```

#### 出力データ構造（Dify → システム）
```typescript
interface DifyChatbotResponse {
  week_start_date: string;
  menus: {
    date: string;
    main: {
      id: string;
      name: string;
      genre: string;
      time: number;
      difficulty: number;
      ingredients: {
        id: string;
        name: string;
        qty: number;
        unit: string;
        category: string;
        invId: string | null;
      }[];
    };
    side?: { ... } | null;
    soup?: { ... } | null;
  }[];
  notes: string[];
}
```

### AI連携の利点
- **高度な文脈理解**: 家族構成・好みの深い理解
- **創造的提案**: より多様で個性的なメニュー
- **在庫最適化**: 期限・量を考慮した効率的活用
- **学習機能**: 評価データからの継続改善

## 🔄 主要処理フロー

### 1. メニュー生成フロー
```
入力設定 → データ変換 → AI/ローカル生成 → レシピ選択 → 分量調整 → メニュープラン保存
```

#### 詳細ステップ
1. **入力検証**: 期間・料理配分の整合性チェック
2. **データ準備**: システム形式 → Dify形式変換
3. **AI生成**: Difyチャットボット呼び出し
4. **フォールバック**: API失敗時のローカル生成
5. **データ変換**: Dify形式 → システム形式変換
6. **保存処理**: データベースへの永続化

### 2. 買い物リスト生成フロー
```
メニュープラン → 食材抽出 → 在庫照合 → 不足分計算 → カテゴリ分類 → リスト生成
```

#### 詳細ステップ
1. **食材収集**: 全レシピから必要食材を抽出
2. **重複統合**: 同一食材の合計必要量計算
3. **在庫照合**: 現在在庫との差分計算
4. **不足分特定**: 購入が必要な食材・量の決定
5. **カテゴリ分類**: 買い物効率を考慮した分類
6. **内訳表示**: 料理別の使用量詳細

### 3. 調理完了・評価フロー
```
完了選択 → 評価入力 → 在庫消費 → 評価保存 → 頻度更新 → カレンダー反映
```

#### 詳細ステップ
1. **完了選択**: カレンダーから完了日を選択
2. **評価入力**: 4項目×5段階の詳細評価
3. **総合判定**: S/A/B/C級の自動判定
4. **在庫消費**: 使用食材の自動減算
5. **評価保存**: データベースへの評価記録
6. **頻度反映**: 今後の出現頻度への反映

## 🎨 UI/UX設計

### デザインシステム

#### カラーパレット
- **プライマリ**: オレンジ系（#F97316 - #EA580C）
- **セカンダリ**: グリーン系（#10B981 - #059669）
- **アクセント**: ブルー系（#3B82F6 - #2563EB）
- **カテゴリ別**:
  - 野菜: グリーン系
  - 肉・魚: レッド系
  - 調味料: オレンジ系
  - その他: グレー系

#### レスポンシブデザイン
- **モバイル**: 下部ナビゲーション
- **デスクトップ**: 左サイドバーナビゲーション
- **ブレークポイント**: Tailwind CSS標準

#### インタラクション
- **ホバー効果**: 全ボタン・カードに適用
- **トランジション**: 200ms統一
- **アニメーション**: 展開・折りたたみ、ローディング
- **フィードバック**: 操作結果の視覚的確認

### アクセシビリティ
- **キーボード操作**: 全機能でサポート
- **スクリーンリーダー**: 適切なaria属性
- **コントラスト**: WCAG AA準拠
- **フォーカス管理**: 明確なフォーカス表示

## 🔧 技術実装詳細

### 状態管理
- **React Hooks**: useState, useEffect中心
- **カスタムフック**: useAuth, useUserData, useDifyConfig
- **ローカル状態**: ページ固有の一時的状態
- **永続化**: Supabaseデータベース

### データフロー
```
UI操作 → カスタムフック → Supabaseクライアント → データベース → リアルタイム更新
```

### エラーハンドリング
- **API エラー**: 適切なエラーメッセージ表示
- **ネットワークエラー**: オフライン対応
- **バリデーションエラー**: 入力検証とフィードバック
- **フォールバック**: 代替手段の提供

### パフォーマンス最適化
- **遅延読み込み**: 大量データの段階的読み込み
- **メモ化**: 重い計算結果のキャッシュ
- **仮想化**: 長いリストの効率的表示
- **バンドル最適化**: Viteによる最適化

## 📊 データ分析・統計

### 利用統計
- **総メニュー数**: 生成されたメニューの総数
- **総料理数**: 作成された料理の総数
- **月間メニュー**: 当月のメニュー数
- **最近の活動**: 直近1週間の活動

### 評価分析
- **評価分布**: S/A/B/C級の分布
- **人気料理**: 高評価料理のランキング
- **改善対象**: C級料理の特定と除外

### 在庫分析
- **期限管理**: 期限切れ・間近・新鮮の分布
- **消費パターン**: 食材の使用頻度
- **ロス削減**: 期限切れ防止効果

## 🔒 セキュリティ仕様

### 認証・認可
- **Supabase Auth**: 業界標準の認証基盤
- **JWT トークン**: セキュアなセッション管理
- **Row Level Security**: データレベルのアクセス制御

### データ保護
- **暗号化通信**: HTTPS強制
- **APIキー管理**: ローカルストレージでの安全な保存
- **CSRF対策**: Supabaseによる自動対策
- **XSS対策**: React標準の自動エスケープ

### プライバシー
- **データ分離**: ユーザー間の完全データ分離
- **最小権限**: 必要最小限のデータアクセス
- **データ削除**: アカウント削除時の完全データ削除

## 🚀 デプロイメント・運用

### 開発環境
- **Vite Dev Server**: 高速開発サーバー
- **Hot Module Replacement**: リアルタイム更新
- **TypeScript**: 開発時型チェック
- **ESLint**: コード品質管理

### 本番環境
- **静的サイト**: Viteビルドによる最適化
- **CDN配信**: 高速コンテンツ配信
- **Supabase**: マネージドバックエンド
- **自動スケーリング**: 負荷に応じた自動拡張

### 監視・メンテナンス
- **エラー監視**: コンソールログによる監視
- **パフォーマンス**: Core Web Vitals監視
- **データベース**: Supabaseダッシュボード監視
- **バックアップ**: 自動データバックアップ

## 📈 今後の拡張計画

### 機能拡張

#### 短期計画（1-3ヶ月）
- **栄養価計算**: カロリー・栄養素の詳細表示
- **レシピ詳細**: 調理手順の詳細表示
- **食材価格**: 概算価格の表示・管理
- **PWA対応**: オフライン機能とアプリ化

#### 中期計画（3-6ヶ月）
- **家族共有**: 複数ユーザーでのメニュー共有
- **外部連携**: レシピサイトとの連携
- **音声入力**: 音声による操作・入力
- **写真認識**: 料理写真からのレシピ推定

#### 長期計画（6ヶ月以上）
- **IoT連携**: スマート冷蔵庫との在庫同期
- **AI学習**: 個人の好み学習機能
- **コミュニティ**: ユーザー間のレシピ共有
- **多言語対応**: 国際化対応

### 技術改善

#### パフォーマンス
- **キャッシュ戦略**: Redis導入
- **画像最適化**: WebP対応
- **バンドル分割**: 動的インポート
- **Service Worker**: オフライン対応

#### 開発効率
- **テスト自動化**: Jest + Testing Library
- **CI/CD**: GitHub Actions
- **コード品質**: Prettier + Husky
- **ドキュメント**: Storybook導入

## 🧪 テスト仕様

### 単体テスト
- **コンポーネント**: React Testing Library
- **ユーティリティ**: Jest
- **フック**: React Hooks Testing Library
- **カバレッジ**: 80%以上を目標

### 統合テスト
- **API連携**: Supabase接続テスト
- **データフロー**: エンドツーエンドテスト
- **認証フロー**: ログイン・ログアウトテスト
- **エラーハンドリング**: 異常系テスト

### E2Eテスト
- **ユーザーシナリオ**: 主要機能の完全テスト
- **ブラウザ互換**: Chrome, Firefox, Safari
- **デバイステスト**: モバイル・デスクトップ
- **パフォーマンス**: Core Web Vitals測定

## 📚 開発ガイドライン

### コーディング規約
- **TypeScript**: 厳密な型定義
- **関数型**: 純粋関数の優先
- **コンポーネント**: 単一責任原則
- **命名規則**: 明確で一貫した命名

### ファイル構成
```
src/
├── components/          # 再利用可能コンポーネント
├── pages/              # ページコンポーネント
├── hooks/              # カスタムフック
├── services/           # 外部サービス連携
├── utils/              # ユーティリティ関数
├── types/              # TypeScript型定義
└── lib/                # ライブラリ設定
```

### Git運用
- **ブランチ戦略**: Git Flow
- **コミット**: Conventional Commits
- **プルリクエスト**: レビュー必須
- **リリース**: セマンティックバージョニング

## 🎯 KPI・成功指標

### ユーザー体験
- **メニュー生成時間**: 3秒以内
- **操作完了率**: 95%以上
- **エラー発生率**: 1%以下
- **ユーザー満足度**: 4.5/5以上

### システム性能
- **ページ読み込み**: 2秒以内
- **API応答時間**: 1秒以内
- **稼働率**: 99.9%以上
- **データ整合性**: 100%

### ビジネス価値
- **食材ロス削減**: 30%削減目標
- **買い物効率**: 計画時間50%短縮
- **料理満足度**: 評価向上20%
- **継続利用率**: 80%以上

## 🛠️ トラブルシューティング

### よくある問題

#### 1. メニュー生成失敗
```
症状: メニューが生成されない
原因: 基本設定未完了、API接続エラー
解決: 設定確認、ネットワーク確認、フォールバック利用
```

#### 2. 在庫同期エラー
```
症状: 買い物後の在庫が更新されない
原因: データベース接続エラー、権限不足
解決: 再ログイン、手動在庫更新
```

#### 3. 評価保存失敗
```
症状: 料理評価が保存されない
原因: ネットワークエラー、データ形式エラー
解決: 再評価、オフライン対応
```

### デバッグ方法
1. **ブラウザ開発者ツール**: コンソール・ネットワーク確認
2. **Supabaseダッシュボード**: データベース状態確認
3. **ローカルストレージ**: 設定データ確認
4. **エラーログ**: 詳細エラー情報の収集

## 📖 ユーザーマニュアル

### 初回セットアップ
1. **アカウント作成**: メール・パスワード登録
2. **基本設定**: 家族構成・好み入力
3. **在庫登録**: 現在の冷蔵庫在庫入力
4. **メニュー生成**: 初回メニュー作成

### 日常的な使用方法
1. **週次メニュー生成**: 毎週のメニュー計画
2. **買い物リスト作成**: 効率的な買い物計画
3. **在庫管理**: 購入・消費の記録
4. **料理評価**: 完了時の満足度評価

### 高度な機能
1. **AI連携設定**: Difyチャットボット連携
2. **メニュー調整**: ドラッグ&ドロップ入れ替え
3. **評価分析**: 過去評価の傾向分析
4. **在庫最適化**: 期限・量を考慮した提案

## 🌟 システムの価値提案

### ユーザーメリット
- **時間節約**: メニュー考案時間の大幅短縮
- **食材ロス削減**: 計画的な食材利用
- **栄養バランス**: ヘルスモード対応の健康的な食事
- **家族満足**: 好みを反映したパーソナライズ

### 技術的優位性
- **最新技術**: React 18 + TypeScript + Supabase
- **AI連携**: 先進的なチャットボット統合
- **セキュリティ**: 企業レベルのデータ保護
- **拡張性**: モジュラー設計による柔軟な拡張

### 競合優位性
- **総合性**: メニュー生成から在庫管理まで一元化
- **AI活用**: 個人最適化されたメニュー提案
- **実用性**: 実際の家庭での使いやすさ重視
- **継続改善**: 評価フィードバックによる品質向上

---

*最終更新: 2025年1月*  
*バージョン: v1.0*  
*対象システム: 料理管理システム（Difyチャットボット連携対応）*