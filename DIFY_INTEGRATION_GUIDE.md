# Difyチャットボット連携ガイド

## 📋 概要

このガイドでは、料理管理システムとDifyで作成したチャットボットをAPI連携する手順を説明します。

## 🚀 連携手順

### 1. Difyでチャットボットアプリを作成

1. **Difyにログイン**してアプリを作成
2. **チャットボットタイプ**を選択
3. **システムプロンプト**に以下を設定：

```
あなたは bolt.new 上で動作するチャットボットです。  
このチャットボットは、ユーザーから「献立作成リクエスト」を受け取り、  
**必ず定義されたJSON形式で出力** してください。  

# 入力仕様（ユーザーから与えられるJSON）
ユーザーは次のような JSON を送ります：

{
  "week_start_date": "YYYY-MM-DD",
  "days": 7,
  "people": 4,
  "diet_mode": true,
  "budget_per_day_jpy": 1500,
  "time_limit_per_day_min": 45,
  "preferred_genres": ["和食", "洋食", "中華"],
  "avoid_genres": [],
  "allergies": [],
  "dislikes": [],
  "must_use_ingredients": [],
  "inventory": [
    {
      "invId": "inv-001",
      "name": "玉ねぎ",
      "qty": 600,
      "unit": "g",
      "category": "野菜",
      "expires_at": "YYYY-MM-DD",
      "priority_hint": "overstock|near_expiry|normal"
    }
  ],
  "pantry": [
    { "name": "醤油", "unit": "ml" },
    { "name": "塩", "unit": "g" }
  ]
}

# 出力仕様（あなたが返すJSON）
出力は以下の形式に厳密に従ってください。**JSON以外の文字列を含めてはいけません**。

{
  "week_start_date": "YYYY-MM-DD",
  "menus": [
    {
      "date": "YYYY-MM-DD",
      "main": {
        "id": "recipe-xxx",
        "name": "料理名",
        "genre": "和食|洋食|中華",
        "time": 10,
        "difficulty": 1,
        "ingredients": [
          {
            "id": "ing-xxx",
            "name": "食材名",
            "qty": 100,
            "unit": "g|ml|個",
            "category": "肉・魚|野菜|調味料|その他",
            "invId": "inv-xxx|null"
          }
        ]
      },
      "side": { ... | null },
      "soup": { ... | null }
    }
  ],
  "notes": []
}

# 制約ルール
1. 出力は必ず有効なJSONのみ。  
2. category は「肉・魚 / 野菜 / 調味料 / その他」の4種類のみ。  
3. unit は g / ml / 個 のみ。醤油は必ず ml。  
4. diet_mode = true の場合は、揚げ物禁止・脂質控えめ（バターや油は最小限）。  
5. 在庫利用時は `invId` を必ず付与。  
6. 在庫の消費期限を超えた食材は使用不可。  
7. JSONの妥当性を必ず守る。  

# 出力例
{
  "week_start_date": "2025-08-25",
  "menus": [
    {
      "date": "2025-08-25",
      "main": {
        "id": "recipe-001",
        "name": "鶏むね肉の照り焼き",
        "genre": "和食",
        "time": 25,
        "difficulty": 2,
        "ingredients": [
          { "id": "ing-001", "name": "鶏むね肉", "qty": 600, "unit": "g", "category": "肉・魚", "invId": "inv-002" },
          { "id": "ing-002", "name": "醤油", "qty": 30, "unit": "ml", "category": "調味料", "invId": null },
          { "id": "ing-003", "name": "みりん", "qty": 20, "unit": "ml", category": "調味料", "invId": null }
        ]
      },
      "side": {
        "id": "recipe-002",
        "name": "小松菜のおひたし",
        "genre": "和食",
        "time": 10,
        "difficulty": 1,
        "ingredients": [
          { "id": "ing-004", "name": "小松菜", "qty": 200, "unit": "g", "category": "野菜", "invId": null },
          { "id": "ing-005", "name": "醤油", "qty": 8, "unit": "ml", "category": "調味料", "invId": null }
        ]
      },
      "soup": {
        "id": "recipe-003",
        "name": "豆腐の味噌汁",
        "genre": "和食",
        "time": 10,
        "difficulty": 1,
        "ingredients": [
          { "id": "ing-006", "name": "豆腐", "qty": 300, "unit": "g", "category": "その他", "invId": "inv-003" },
          { "id": "ing-007", "name": "味噌", "qty": 20, "unit": "g", "category": "調味料", "invId": "inv-004" }
        ]
      }
    }
  ],
  "notes": ["在庫の鶏むね肉(inv-002)と味噌(inv-004)を使用しました。"]
}
```

### 2. APIエンドポイントとキーを取得

1. **API設定**でエンドポイントURLを確認
2. **APIキー**を生成・取得
3. **権限設定**でチャット機能を有効化

### 3. 料理管理システムで設定

1. **ホーム画面**の「AIチャットボット連携」セクションで「設定」をクリック
2. **APIエンドポイント**と**APIキー**を入力
3. **接続テスト**で動作確認
4. **保存**して設定完了

### 4. メニュー生成の実行

1. **AIチャットボット連携**のチェックボックスをON
2. **メニューを生成**ボタンをクリック
3. DifyのAIが高度なメニューを生成

## 🔧 技術仕様

### API通信フロー

```
料理管理システム → Dify API → AIモデル → JSON応答 → システム内部形式変換
```

### データ変換

1. **入力変換**: システム内部データ → Dify JSON形式
2. **出力変換**: Dify JSON応答 → システム内部Recipe[]形式
3. **エラーハンドリング**: API失敗時はローカル生成にフォールバック

### セキュリティ

- **APIキー**: ローカルストレージに暗号化保存
- **HTTPS通信**: 全ての通信は暗号化
- **エラー処理**: 適切なエラーメッセージとフォールバック

## 🎯 連携のメリット

### AIによる高度な生成

- **文脈理解**: 家族構成や好みを深く理解
- **創造性**: より多様で個性的なメニュー提案
- **学習能力**: 使用パターンから最適化

### 在庫活用の最適化

- **期限管理**: 期限間近食材の優先利用
- **無駄削減**: 大量在庫の効率的消費
- **栄養バランス**: ヘルスモードに応じた最適化

### ユーザー体験の向上

- **パーソナライゼーション**: 個人の好みに特化
- **時短対応**: 忙しい日の時間制約考慮
- **継続改善**: フィードバックによる品質向上

## 🛠️ トラブルシューティング

### よくある問題と解決方法

#### 1. API接続エラー
```
症状: 「接続テスト失敗」メッセージ
原因: APIエンドポイントまたはAPIキーが間違っている
解決: Difyの設定画面で正しい値を再確認
```

#### 2. JSON形式エラー
```
症状: 「無効なレスポンス形式」エラー
原因: DifyのシステムプロンプトでJSON出力が正しく設定されていない
解決: システムプロンプトを再設定し、JSON出力を厳密に指定
```

#### 3. 生成失敗
```
症状: メニュー生成が完了しない
原因: Dify APIの応答時間が長い、または制限に達している
解決: ローカル生成にフォールバックされるため、しばらく待つか再試行
```

### デバッグ方法

1. **ブラウザの開発者ツール**でコンソールログを確認
2. **ネットワークタブ**でAPI通信を監視
3. **Difyのログ**で処理状況を確認

## 📊 パフォーマンス最適化

### API呼び出しの最適化

- **タイムアウト設定**: 30秒でタイムアウト
- **リトライ機能**: 失敗時の自動再試行
- **キャッシュ**: 同一条件での結果キャッシュ

### ユーザー体験の改善

- **ローディング表示**: 生成中の進捗表示
- **フォールバック**: API失敗時の代替手段
- **エラー通知**: 分かりやすいエラーメッセージ

## 🔮 今後の拡張

### 機能拡張の可能性

- **自然言語入力**: 「今日は疲れているので簡単な料理で」
- **学習機能**: 評価データからの好み学習
- **栄養分析**: カロリーや栄養素の詳細分析
- **季節対応**: 旬の食材を活用した提案

### システム連携の拡張

- **複数AI対応**: 異なるAIサービスとの連携
- **外部API**: レシピサイトや栄養データベース連携
- **IoT連携**: スマート冷蔵庫との在庫同期

---

*最終更新: 2025年1月*
*対象システム: 料理管理システム v1.0 + Dify連携*